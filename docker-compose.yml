services:
    postgres:
        image: postgres
        container_name: postgres-db
        restart: always
        environment:
            POSTGRES_DB: avian_db
            POSTGRES_USER: user
            POSTGRES_PASSWORD: user
        ports:
            - "5432:5432"
        volumes:
            - postgres-db_data:/var/lib/postgresql/data
            - ./init-db:/docker-entrypoint-initdb.d
    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        container_name: backend_app
        depends_on:
            - postgres
            - localstack
        env_file:
            - ./backend/.env
            - ./backend/.env.local
        ports:
            - "8080:8080"
            - "5005:5005"
        restart: unless-stopped
    localstack:
        container_name: "${LOCALSTACK_DOCKER_NAME:-localstack-main}"
        build:
            context: .
            dockerfile: Dockerfile.localstack
        ports:
            - "4566:4566"
        environment:
            - DEBUG=${DEBUG:-0}
            - DEFAULT_REGION=ap-southeast-2
        volumes:
            - "${LOCALSTACK_VOLUME_DIR:-./volume}:/var/lib/localstack"
            - "/var/run/docker.sock:/var/run/docker.sock"
            - ./localstack/init-s3:/etc/localstack/init/ready.d
            - ./localstack:/persisted-data
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile.local
        container_name: frontend_app
        env_file:
            - ./frontend/.env
            - ./frontend/.env.local
        ports:
            - "5173:5173"
        restart: unless-stopped
        volumes:
            - ./frontend:/app
            - /app/node_modules

    pgadmin:
        image: dpage/pgadmin4
        container_name: pgadmin
        restart: unless-stopped
        environment:
            PGADMIN_DEFAULT_EMAIL: admin@admin.com
            PGADMIN_DEFAULT_PASSWORD: admin
            PGADMIN_CONFIG_SERVER_MODE: "False"
        ports:
            - "8081:80" # Access pgAdmin at http://localhost:8081
        depends_on:
            - postgres
        volumes:
            - pgadmin-data:/var/lib/pgadmin
            - ./servers.json:/pgadmin4/servers.json
volumes:
    postgres-db_data:
    pgadmin-data:
